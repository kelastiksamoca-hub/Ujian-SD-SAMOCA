<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<title>TO | SD Santa Maria Monica</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
:root{
  --utama:#6f7bd9;
  --aksen:#f5c542;
  --siswa:#4CAF50;
}
*{box-sizing:border-box}
body{
  margin:0;
  font-family:'Segoe UI',sans-serif;
  background:linear-gradient(135deg,#6f7bd9,#9b6bd6);
}
.login-wrapper{
  min-height:100vh;
  display:flex;
  justify-content:center;
  align-items:center;
  padding:20px;
}
.login-card{
  background:white;
  width:100%;
  max-width:420px;
  padding:28px;
  border-radius:24px;
  box-shadow:0 25px 50px rgba(0,0,0,.25);
  text-align:center;
}
.login-card img{width:85px}
.role-box{
  display:flex;
  gap:12px;
  margin:18px 0;
}
.role-btn{
  flex:1;
  padding:12px;
  border-radius:16px;
  border:2px solid #ddd;
  cursor:pointer;
  font-weight:600;
}
.role-btn.active{
  background:var(--utama);
  color:white;
  border-color:var(--utama);
}
.role-btn.siswa.active{
  background:var(--siswa);
  border-color:var(--siswa);
}
.input-box{position:relative}
input,select{
  width:100%;
  padding:14px;
  border-radius:14px;
  border:1px solid #ddd;
  margin-bottom:14px;
}
.eye{
  position:absolute;
  right:14px;
  top:14px;
  cursor:pointer;
}
button{
  padding:14px;
  border-radius:16px;
  border:none;
  background:linear-gradient(135deg,#6f7bd9,#9b6bd6);
  color:white;
  font-weight:600;
  cursor:pointer;
}
.container{
  max-width:1200px;
  margin:auto;
  padding:20px;
}
.header{
  text-align:center;
  color:white;
}
.header img{width:90px}
.card{
  background:white;
  border-radius:20px;
  padding:22px;
  margin-bottom:25px;
  box-shadow:0 15px 35px rgba(0,0,0,.15);
}
.grid{
  display:grid;
  grid-template-columns:repeat(auto-fit,minmax(260px,1fr));
  gap:20px;
}
.soal-card{
  background:white;
  border-radius:18px;
  padding:18px;
  box-shadow:0 10px 25px rgba(0,0,0,.15);
}
.badge{
  display:inline-block;
  padding:6px 12px;
  background:var(--utama);
  color:white;
  border-radius:20px;
  font-size:12px;
}
table{width:100%;border-collapse:collapse}
th{
  background:var(--utama);
  color:white;
  padding:10px;
}
  
/* ===============================
   FIX IFRAME GOOGLE FORM DI HP
   =============================== */

.soal-wrapper {
  width: 100%;
  max-width: 100%;
  margin: 0 auto;
}

/* DESKTOP */
.iframe-soal {
  width: 100%;
  height: 80vh;
  border: none;
}

/* HP */
@media (max-width: 768px) {

  /* HILANGKAN JERAT TEMA BLOGSPOT */
  body,
  .content,
  .container,
  .post-body {
    padding: 0 !important;
    margin: 0 !important;
  }

  /* KELUAR DARI KONTENER */
  .soal-wrapper {
    width: 100vw;
    margin-left: calc(-50vw + 50%);
    overflow: hidden;
  }

  /* IFRAME FULL LAYAR */
  .iframe-soal {
    width: 100vw;
    height: 140vh;
    border: none;
  }
}
  
.topbar{
  background:#c7a9f2;
  padding:14px 20px;
  display:flex;
  justify-content:space-between;
  align-items:center;
}
.top-left{
  display:flex;
  align-items:center;
  gap:12px;
}
.top-left img{width:55px}
.top-left h2{margin:0}
.top-left small{color:#0a2aff;font-weight:600}

.top-right{
  display:flex;
  gap:10px;
}

.btn-blue{
  background:#0a2aff;
  border:none;
  padding:10px 18px;
  color:white;
  border-radius:20px;
  font-weight:600;
}

.btn-red{
  background:#ff3b3b;
  border:none;
  padding:10px 18px;
  color:white;
  border-radius:20px;
  font-weight:600;
}

.admin-grid{
  display:grid;
  grid-template-columns:1fr 1fr;
  gap:20px;
}

@media (max-width:768px){
  .admin-grid{
    grid-template-columns:1fr;
  }
}

.btn-green{background:#4CAF50}
.btn-dark{background:#1e2aff}
.btn-gray{background:#999}

td {
  padding: 10px;
  text-align: center;
}
  
.btn{
  border:none;
  padding:8px 14px;
  border-radius:14px;
  font-weight:600;
  cursor:pointer;
  margin:3px;
}

.btn-enable{
  background:#4CAF50;
  color:white;
}

.btn-disable{
  background:#1e2aff;
  color:white;
}

.btn-delete{
  background:#ff3b3b;
  color:white;
}

.btn-disabled{
  background:#bbb;
  color:#666;
  cursor:not-allowed;
}

.modal{
  position:fixed;
  inset:0;
  background:rgba(0,0,0,.4);
  display:none;
  align-items:center;
  justify-content:center;
  z-index:999;
}

.modal-card{
  background:white;
  padding:24px;
  border-radius:22px;
  width:90%;
  max-width:360px;
  text-align:center;
  box-shadow:0 20px 40px rgba(0,0,0,.3);
}

.modal-btn{
  display:flex;
  justify-content:center;
  gap:12px;
  margin-top:18px;
}

  .container-admin{
  width:100%;
  max-width:none;
  padding:20px 30px;
}

.card-full{
  width:100%;
}

table{
  width:100%;
}

th, td{
  text-align:center;
}

td:last-child{
  min-width:220px; /* ruang tombol */
}
.aksi-box{
  display:flex;
  justify-content:center;
  gap:8px;
  flex-wrap:wrap;
}
#adminMode .container,
.container-admin{
  max-width:100% !important;
  width:100% !important;
  margin:0 !important;
}
.card-daftar-soal{
  width:100% !important;
  max-width:none !important;
  margin:0 !important;
}

  th:nth-child(4),
td:nth-child(4){
  text-align:center;
  font-weight:600;
}
/* ===============================
   RESPONSIVE MODE HP
   =============================== */
@media (max-width: 768px){

  /* GLOBAL FONT */
  body{
    font-size:14px;
  }

  h2{font-size:18px}
  h3{font-size:16px}
  h4{font-size:15px}

  /* LOGIN */
  .login-card{
    padding:20px;
    border-radius:18px;
  }

  .role-box{
    flex-direction:column;
  }

  .role-btn{
    padding:14px;
    font-size:15px;
  }

  /* TOPBAR */
  .topbar{
    flex-direction:column;
    gap:10px;
    text-align:center;
  }

  .top-left{
    justify-content:center;
  }

  .top-right{
    width:100%;
  }

  .top-right button{
    flex:1;
    width:100%;
    border-radius:14px;
    padding:12px;
    font-size:14px;
  }

  /* CONTAINER */
  .container,
  .container-admin{
    padding:12px;
  }

  .card{
    padding:16px;
    border-radius:16px;
  }

  /* GRID KARTU SISWA */
  .grid{
    grid-template-columns:1fr;
  }

  .soal-card{
    padding:16px;
  }

  .soal-card button{
    width:100%;
    padding:12px;
    font-size:14px;
  }

  /* TABEL ADMIN */
  table{
    display:block;
    overflow-x:auto;
    white-space:nowrap;
  }

  th, td{
    font-size:13px;
    padding:8px;
  }

  /* AKSI BUTTON */
  .aksi-box{
    flex-direction:column;
    align-items:stretch;
  }

  .aksi-box .btn{
    width:100%;
    font-size:13px;
    padding:10px;
  }

  /* BUTTON UMUM */
  button{
    font-size:14px;
    padding:12px;
  }

  /* MODAL */
  .modal-card{
    padding:18px;
    border-radius:18px;
  }

  /* TIMER & HEADER UJIAN */
  #siswaUjian h3{
    font-size:16px;
  }

  #timer{
    font-size:16px;
  }
}

/* ===============================
   STICKY TIMER UJIAN
   =============================== */

.ujian-header{
  position:sticky;
  top:0;
  z-index:999;
  background:white;
  padding:14px 16px;
  border-radius:0 0 18px 18px;
  box-shadow:0 8px 20px rgba(0,0,0,.15);
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:12px;
}

.timer-box{
  background:#ffeb3b;
  color:#000;
  padding:8px 14px;
  border-radius:20px;
  font-weight:700;
  font-size:15px;
}

.btn-kembali{
  background:#ff3b3b;
  color:white;
  border:none;
  padding:8px 14px;
  border-radius:16px;
  font-weight:600;
}

/* MODE HP */
@media (max-width:768px){

  .ujian-header{
    flex-direction:column;
    text-align:center;
    gap:8px;
    padding:12px;
  }

  .timer-box{
    width:100%;
    font-size:16px;
  }

  .btn-kembali{
    width:100%;
    font-size:14px;
  }
}

/* Zebra striping TERANG */
.card-daftar-soal table tbody tr:nth-child(odd){
  background:#ffffff; /* putih bersih */
}


/* Hover lembut */
.card-daftar-soal table tbody tr:hover{
  background:#eef2ff; /* ungu muda lembut */
}

table td, table th{
  border-bottom:1px solid #eee;
}
.card-daftar-soal table td{
  border-bottom:1px solid #eee;
}

/* ===============================
   GLOBAL SMOOTH TRANSITION
   =============================== */

*{
  transition: all .25s ease;
}

body{
  animation: fadeBody .6s ease;
}

@keyframes fadeBody{
  from{opacity:0}
  to{opacity:1}
}

/* ===============================
   LOGIN ANIMATION
   =============================== */

.login-card{
  animation: slideUp .7s cubic-bezier(.22,.61,.36,1);
}

@keyframes slideUp{
  from{
    opacity:0;
    transform:translateY(40px) scale(.95);
  }
  to{
    opacity:1;
    transform:translateY(0) scale(1);
  }
}

/* ===============================
   CARD ANIMATION
   =============================== */

.card,
.soal-card{
  opacity:0;
  transform:translateY(25px);
  animation: cardFade .6s forwards;
}

@keyframes cardFade{
  to{
    opacity:1;
    transform:translateY(0);
  }
}

/* Stagger effect */
.grid .soal-card:nth-child(1){animation-delay:.05s}
.grid .soal-card:nth-child(2){animation-delay:.1s}
.grid .soal-card:nth-child(3){animation-delay:.15s}
.grid .soal-card:nth-child(4){animation-delay:.2s}
.grid .soal-card:nth-child(5){animation-delay:.25s}

/* ===============================
   HOVER LIFT EFFECT
   =============================== */

.card:hover,
.soal-card:hover{
  transform:translateY(-6px);
  box-shadow:0 20px 45px rgba(0,0,0,.2);
}

/* ===============================
   BUTTON RIPPLE EFFECT
   =============================== */

button{
  position:relative;
  overflow:hidden;
}

button::after{
  content:"";
  position:absolute;
  width:20px;
  height:20px;
  background:rgba(255,255,255,.4);
  border-radius:50%;
  transform:scale(0);
  opacity:0;
  pointer-events:none;
}

button:active::after{
  transform:scale(8);
  opacity:1;
  transition:transform .4s ease, opacity .6s ease;
}

/* ===============================
   MODAL ANIMATION
   =============================== */

.modal{
  animation: fadeModal .3s ease;
}

.modal-card{
  animation: zoomModal .35s cubic-bezier(.22,.61,.36,1);
}

@keyframes fadeModal{
  from{opacity:0}
  to{opacity:1}
}

@keyframes zoomModal{
  from{
    opacity:0;
    transform:scale(.85);
  }
  to{
    opacity:1;
    transform:scale(1);
  }
}

/* ===============================
   TOPBAR SMOOTH
   =============================== */

.topbar{
  animation: slideDown .5s ease;
}

@keyframes slideDown{
  from{
    transform:translateY(-40px);
    opacity:0;
  }
  to{
    transform:translateY(0);
    opacity:1;
  }
}

/* ===============================
   TIMER WARNING EFFECT
   =============================== */

.timer-box.warning{
  animation:pulseTimer 1s infinite;
  background:#ff3b3b;
  color:white;
}

@keyframes pulseTimer{
  0%{transform:scale(1)}
  50%{transform:scale(1.08)}
  100%{transform:scale(1)}
}

/* =====================================================
   üî• SUPER PREMIUM UI ‚Äì SD SANTA MARIA MONICA
   ===================================================== */

/* ===============================
   GLOBAL SMOOTH
   =============================== */

*{
  transition: all .25s ease;
}

body{
  background:linear-gradient(-45deg,#6f7bd9,#9b6bd6,#4CAF50,#6f7bd9);
  background-size:400% 400%;
  animation:gradientMove 12s ease infinite, fadeBody .6s ease;
}

@keyframes gradientMove{
  0%{background-position:0% 50%}
  50%{background-position:100% 50%}
  100%{background-position:0% 50%}
}

@keyframes fadeBody{
  from{opacity:0}
  to{opacity:1}
}

/* ===============================
   GLASSMORPHISM
   =============================== */

.login-card,
.card,
.soal-card,
.modal-card{
  background:rgba(255,255,255,0.75);
  backdrop-filter:blur(15px);
  -webkit-backdrop-filter:blur(15px);
  border:1px solid rgba(255,255,255,0.3);
}

/* ===============================
   LOGIN ANIMATION
   =============================== */

.login-card{
  animation:slideUp .7s cubic-bezier(.22,.61,.36,1);
}

@keyframes slideUp{
  from{
    opacity:0;
    transform:translateY(40px) scale(.95);
  }
  to{
    opacity:1;
    transform:translateY(0) scale(1);
  }
}

/* ===============================
   CARD APPEAR + FLOAT EFFECT
   =============================== */

.card,
.soal-card{
  opacity:0;
  transform:translateY(25px);
  animation:cardFade .6s forwards;
  transform-style:preserve-3d;
}

@keyframes cardFade{
  to{
    opacity:1;
    transform:translateY(0);
  }
}

/* Stagger animation */
.grid .soal-card:nth-child(1){animation-delay:.05s}
.grid .soal-card:nth-child(2){animation-delay:.1s}
.grid .soal-card:nth-child(3){animation-delay:.15s}
.grid .soal-card:nth-child(4){animation-delay:.2s}
.grid .soal-card:nth-child(5){animation-delay:.25s}

/* Hover premium depth */
.card:hover,
.soal-card:hover{
  transform:translateY(-10px) rotateX(3deg) rotateY(-3deg);
  box-shadow:0 25px 60px rgba(0,0,0,.25);
}

/* ===============================
   BUTTON MICRO INTERACTION
   =============================== */

button{
  position:relative;
  overflow:hidden;
}

button:hover{
  transform:translateY(-2px);
  box-shadow:0 8px 18px rgba(0,0,0,.25);
}

button:active{
  transform:scale(.96);
}

/* Ripple effect */
button::after{
  content:"";
  position:absolute;
  width:20px;
  height:20px;
  background:rgba(255,255,255,.4);
  border-radius:50%;
  transform:scale(0);
  opacity:0;
  pointer-events:none;
}

button:active::after{
  transform:scale(8);
  opacity:1;
  transition:transform .4s ease, opacity .6s ease;
}

/* ===============================
   TOPBAR ANIMATION
   =============================== */

.topbar{
  animation:slideDown .5s ease;
}

@keyframes slideDown{
  from{
    transform:translateY(-40px);
    opacity:0;
  }
  to{
    transform:translateY(0);
    opacity:1;
  }
}

/* ===============================
   PAGE TRANSITION
   =============================== */

.fade-page{
  animation:fadePage .5s ease;
}

@keyframes fadePage{
  from{
    opacity:0;
    transform:translateY(20px);
  }
  to{
    opacity:1;
    transform:translateY(0);
  }
}

/* ===============================
   MODAL PREMIUM
   =============================== */

.modal{
  backdrop-filter:blur(6px);
  animation:fadeModal .3s ease;
}

.modal-card{
  animation:zoomModal .35s cubic-bezier(.22,.61,.36,1);
}

@keyframes fadeModal{
  from{opacity:0}
  to{opacity:1}
}

@keyframes zoomModal{
  from{
    opacity:0;
    transform:scale(.85);
  }
  to{
    opacity:1;
    transform:scale(1);
  }
}

/* ===============================
   TIMER WARNING + PROGRESS BAR
   =============================== */

.timer-box.warning{
  animation:pulseTimer 1s infinite;
  background:#ff3b3b;
  color:white;
}

@keyframes pulseTimer{
  0%{transform:scale(1)}
  50%{transform:scale(1.08)}
  100%{transform:scale(1)}
}

/* Progress bar */

.progress-container{
  width:100%;
  height:8px;
  background:#eee;
  border-radius:10px;
  overflow:hidden;
  margin-top:8px;
}

#progressBar{
  height:100%;
  width:100%;
  background:linear-gradient(90deg,#4CAF50,#ff3b3b);
  transition:width 1s linear;
}

/* ===============================
   SKELETON LOADING
   =============================== */

.skeleton{
  height:120px;
  border-radius:18px;
  margin-bottom:15px;
  background:linear-gradient(90deg,#eee,#ddd,#eee);
  background-size:200% 100%;
  animation:skeletonMove 1.2s infinite;
}

@keyframes skeletonMove{
  0%{background-position:200% 0}
  100%{background-position:-200% 0}
}

/* ===============================
   TOAST NOTIFICATION
   =============================== */

.toast{
  position:fixed;
  bottom:30px;
  right:30px;
  background:#333;
  color:white;
  padding:14px 22px;
  border-radius:14px;
  opacity:0;
  transform:translateY(20px);
  transition:.4s;
  z-index:9999;
}

.toast.show{
  opacity:1;
  transform:translateY(0);
}


</style>
</head>

<body>

<!-- LOGIN -->
<div class="login-wrapper" id="loginBox">
  <div class="login-card">
    
    <img 
  		src="https://www.stmariamonica.com/assets/images/logo-samoca-png.png"
 		width="90"
  		height="90"
  		loading="lazy"
	>

    <h2>TO</h2>
    <h3>SD SANTA MARIA MONICA</h3>

    <div class="role-box">
      <div 
        class="role-btn active" 
        id="btnAdmin" 
        onclick="setRole('admin')"
      >
        üë©‚Äçüíº Admin
      </div>

      <div 
        class="role-btn siswa" 
        id="btnSiswa" 
        onclick="setRole('siswa')"
      >
        üéì Siswa
      </div>
    </div>

    <input id="user" readonly>

    <div class="input-box">
      <input 
        id="pass" 
        type="password" 
        placeholder="Password Admin"
      >
      <span class="eye" onclick="togglePass()">üëÅÔ∏è</span>
    </div>
    <input 
      id="namaSiswa"
      placeholder="Nama Lengkap"
      style="display:none"
    >
   
    <input 
      id="tokenInput" 
      placeholder="Token Ujian" 
      style="display:none"
    >

    <input 
      id="noUjian"
      placeholder="No Ujian Contoh: 01-6A"
      style="display:none"
    >

    <button onclick="login()">Masuk</button>

  </div>
</div>

  
  
<!-- APP -->
<div id="app" style="display:none">

<div class="topbar">
  <div class="top-left">
    <img src="https://www.stmariamonica.com/assets/images/logo-samoca-png.png">
    <div>
      <h2>TO</h2>
      <small>SD Santa Maria Monica</small>
    </div>
  </div>

  <div class="top-right">
  <button 
    class="btn-blue" 
    id="btnModeSiswa"
    onclick="adminPreviewSiswa()"
  >
    MODE SISWA
  </button>
  <button class="btn-red" onclick="logout()">LOGOUT</button>
</div>
</div>

<div class="container container-admin">

<!-- ADMIN -->
<div id="adminMode" style="display:none">

  <div class="card">
    <h3>üìä Dashboard</h3>
    <p>Total Soal: <b id="totalSoal">0</b></p>
  </div>

  <div class="admin-grid">


<div class="card">
  <h3>‚ûï Tambah Soal</h3>
  <select id="jenis">
    <option>TO</option>
    <option>UAS</option>
  </select>
  <select id="mapel">
    <option>Pendidikan Agama</option>
    <option>Pendidikan Pancasila</option>
    <option>Bahasa Indonesia</option>
    <option>Matematika</option>
    <option>IPAS</option>
    <option>Seni Musik</option>
    <option>Seni Tari</option>
    <option>Seni Rupa</option>
    <option>Bahasa Inggris</option>
    <option>Bahasa Sunda</option>
    <option>PJOK</option>
    <option>Informatika</option>
  </select>
  <select id="durasi">
    <option>30</option>
    <option>45</option>
    <option>60</option>
    <option>90</option>
    <option>120</option>
  </select>
  <input id="link" placeholder="Link Soal">
  <button onclick="simpan()">Simpan</button>
</div>

<!-- ‚úÖ KEL0LA TOKEN (INI YANG TADI BELUM ADA) -->
<div class="card">
  <h3>üîë Kelola Token</h3>
  <input id="tokenBaru" placeholder="Masukkan Token">
  <button onclick="tambahToken()">Tambah Token</button>

  <table style="margin-top:15px">
    <thead>
      <tr><th>No</th><th>Token</th><th>Aksi</th></tr>
    </thead>
    <tbody id="tokenTable"></tbody>
  </table>
</div>
  </div>
<div class="card card-daftar-soal">
  <h3>üìã Daftar Soal</h3>
  <table>
  <thead>
    <tr>
      <th>No</th>
      <th>Ujian</th>
      <th>Mapel</th>
      <th>Durasi</th>
      <th>Aksi</th>
    </tr>
  </thead>
  <tbody id="tableData"></tbody>
</table>
</div>
<!-- üì° MONITORING SISWA -->
<div class="card">
  <h3>üì° Monitoring Siswa</h3>
  <div style="display:flex;gap:10px;margin-bottom:10px;">
  <button onclick="loadMonitoring()" 
          style="background:#4CAF50">
    üîÑ Refresh Monitoring
  </button>

  <button onclick="hapusSelesai()" 
          style="background:#ff3b3b">
    üóë Hapus Siswa Selesai
  </button>
</div>

  <table>
    <thead>
      <tr>
        <th>No</th>
        <th>No Ujian</th>
        <th>Nama</th>
        <th>Status</th>
        <th>Last Active</th>
      </tr>
    </thead>
    <tbody id="monitoringTable"></tbody>
  </table>
</div>
</div>

<!-- SISWA -->
<div id="siswaMode" style="display:none">
<button 
  id="btnBackAdmin"
  onclick="kembaliKeAdmin()"
  style="display:none;margin-bottom:12px;background:#ff9800"
>
  ‚¨Ö Kembali ke Admin
</button>

<div id="siswaList">
  <p id="adminPreviewLabel" style="display:none;color:#ff5722;font-weight:600">
  üëÄ MODE PREVIEW ADMIN
</p>

  <div class="card">
    <h3 id="namaTampil" style="margin-bottom:15px;"></h3>
    <h3>üìö Daftar Soal</h3>
    <button 
      onclick="refreshSoalSiswa()" 
      style="margin-top:10px;background:#4CAF50"
    >
      üîÑ Refresh Soal
    </button>
    <p id="infoSoal" style="margin-top:10px;color:#666"></p>
  </div>

  <div class="grid" id="cardData"></div>
</div>


<div id="siswaUjian" style="display:none">
  <div class="ujian-header">
  <h3 id="judulUjian"></h3>
  <div class="timer-box">
    ‚è±Ô∏è Sisa Waktu: <b id="timer">00:00</b>
  </div>
  <button class="btn-kembali" onclick="keluarUjian()">‚¨Ö Kembali</button>
</div>

  <div class="soal-wrapper">
  <iframe 
    id="frameSoal"
    class="iframe-soal"
    src="SOAL_ANDA_DI_SINI.html"
    loading="lazy"
    allowfullscreen>
  </iframe>
</div>
</div>

</div>
</div>

<div id="confirmBox" class="modal">
  <div class="modal-card">
    <h3>‚ö†Ô∏è Konfirmasi</h3>
    <p id="confirmText"></p>
    <div class="modal-btn">
      <button class="btn btn-disabled" onclick="closeConfirm()">Batal</button>
      <button class="btn btn-delete" id="confirmOk">Ya, Hapus</button>
    </div>
  </div>
</div>
<script>
window.onbeforeunload = () => {
  sessionStorage.removeItem("preview");
};

const btnAdmin = document.getElementById("btnAdmin");
const btnSiswa = document.getElementById("btnSiswa");
const user = document.getElementById("user");
const pass = document.getElementById("pass");
const tokenInput = document.getElementById("tokenInput");
const noUjian = document.getElementById("noUjian");
const SCRIPT_URL="https://script.google.com/macros/s/AKfycbwLy012pR_g-zeC0lm-MhUgNu4jfALapToT1ANLwYRhGIbACK2AwEMJp_xrLfLpthT9rw/exec";
const MONITOR_URL = "https://script.google.com/macros/s/AKfycbxi0j1GF9NlJ4bLrVmdMpQjfhf8oSdpiss7rq59qzuOiL848O4hZwcDFBk37Yy9v8FH/exec";

let selectedRole="admin";
let cacheSoal=[], cacheToken=[];
let timerInterval, sisaDetik=0;
let hapusID = null;

function adminPreviewSiswa(){

  // ‚ùå JANGAN UBAH ROLE
  // sessionStorage.setItem("role","siswa");  ‚Üê HAPUS BARIS INI

  sessionStorage.setItem("preview","admin");

  document.getElementById("adminPreviewLabel").style.display="block";
  document.getElementById("btnBackAdmin").style.display="block";

  // sembunyikan admin
  adminMode.style.display = "none";

  // tampilkan siswa
  siswaMode.style.display = "block";

  const soalAktif = cacheSoal.filter(r => r[5] == 1);

  if(soalAktif.length === 0){
    cardData.innerHTML = `
      <div class="card">
        <h3>‚è≥ Belum ada soal aktif</h3>
        <p>(Preview Admin)</p>
      </div>`;
    return;
  }

  cardData.innerHTML = "";

  soalAktif.forEach(r=>{
    cardData.innerHTML+=`
      <div class="soal-card">
        <span class="badge">${r[1]}</span>
        <h4>${r[2]}</h4>
        <p>Durasi ${r[3]} menit</p>
        <button onclick="mulaiUjian('${r[2]}',${r[3]},'${r[4]}')">
          üéì Mulai (Preview)
        </button>
      </div>`;
  });
}

function kembaliKeAdmin(){

  // keluar dari preview
  sessionStorage.removeItem("preview");

  // sembunyikan siswa
  siswaMode.style.display = "none";
  siswaUjian.style.display = "none";

  // tampilkan admin
  adminMode.style.display = "block";

  // tampilkan tombol mode siswa lagi
  document.querySelector(".top-right").style.display = "flex";

  loadAdmin();
}

  

function confirmHapus(id){
  hapusID = id;
  confirmText.innerText = "Yakin ingin menghapus soal ini?";
  confirmBox.style.display = "flex";
}

function closeConfirm(){
  confirmBox.style.display = "none";
  hapusID = null;
}

confirmOk.onclick = async ()=>{
  if(!hapusID) return;

  await fetch(SCRIPT_URL,{
    method:"POST",
    body:JSON.stringify({
      action:"DELETE_SOAL",
      id: hapusID
    })
  });

  closeConfirm();
  loadAdmin();
};


function setRole(role){
  selectedRole = role;

  btnAdmin.classList.remove("active");
  btnSiswa.classList.remove("active");

  const passBox = document.querySelector(".input-box");
  const namaInput = document.getElementById("namaSiswa");

  if(role === "admin"){
    btnAdmin.classList.add("active");

    passBox.style.display = "flex";
    pass.value = "";

    namaInput.style.display = "none";
    namaInput.value = "";

    tokenInput.style.display = "none";
    tokenInput.value = "";

    noUjian.style.display = "none";
    noUjian.value = "";

    user.value = "Admin";
  }else{
    btnSiswa.classList.add("active");

    passBox.style.display = "none";
    pass.value = "";

    namaInput.style.display = "block";
    tokenInput.style.display = "block";
    noUjian.style.display = "block";

    user.value = "Siswa";
  }
}

function togglePass(){
  pass.type=pass.type==="password"?"text":"password";
}

async function login(){
  if(selectedRole==="admin"){
    if(pass.value!=="12345") return alert("Password admin salah");

    sessionStorage.setItem("login","true");
    sessionStorage.setItem("role","admin");

    // ‚¨áÔ∏è LANGSUNG MASUK (TANPA RELOAD)
    loginBox.style.display="none";
    app.style.display="block";
    adminMode.style.display="block";
     // ‚úÖ TAMPILKAN MODE SISWA
  	document.getElementById("btnModeSiswa").style.display = "inline-block";
    loadAdmin();

 }else{

  	const nama  = document.getElementById("namaSiswa").value.trim();
    const token = tokenInput.value.trim();
    const no    = noUjian.value.trim();

  	if(!nama || !token || !no){
    alert("Lengkapi Nama, Token, dan No Ujian");
    return;
    }

  	// üî• Simpan login
  	sessionStorage.setItem("login","true");
    sessionStorage.setItem("role","siswa");
    sessionStorage.setItem("token",token);
    sessionStorage.setItem("namaSiswa",nama);
    sessionStorage.setItem("noUjian",no);

  	// Bersihkan preview admin
  	sessionStorage.removeItem("preview");
  	const label = document.getElementById("adminPreviewLabel");
  	if(label) label.style.display = "none";

  	const backBtn = document.getElementById("btnBackAdmin");
  	if(backBtn) backBtn.style.display="none";

  	document.getElementById("btnModeSiswa").style.display = "none";

  	// ‚úÖ Langsung masuk (cepat)
  	loginBox.style.display="none";
  	app.style.display="block";
  	siswaMode.style.display="block";
   
   cardData.innerHTML = `
  	<div class="skeleton"></div>
  	<div class="skeleton"></div>
`	;


  	loadSiswa();          // tampilkan cache dulu
  	refreshSoalSiswa();   // ambil data terbaru di background
}
}

function logout(){
  sessionStorage.clear();
  location.reload();
}

window.onload = ()=>{

  // RESET TAMPILAN DULU (PENTING)
  loginBox.style.display="flex";
  app.style.display="none";
  adminMode.style.display="none";
  siswaMode.style.display="none";
  siswaUjian.style.display="none";

  const login = sessionStorage.getItem("login");
  const role  = sessionStorage.getItem("role");

  if(login==="true" && role){

    loginBox.style.display="none";
    app.style.display="block";

    if(role==="admin"){
      adminMode.style.display="block";
      document.getElementById("btnModeSiswa").style.display="inline-block";
      loadAdmin();
    }

    if(role==="siswa"){
      siswaMode.style.display="block";
      document.getElementById("btnModeSiswa").style.display="none";
      loadSiswa();
      setTimeout(refreshSoalSiswa,500);
    }

  }else{
    setRole("admin");
  }
};

async function loadAdmin(){
  const res = await fetch(SCRIPT_URL+"?role=admin").then(r=>r.json());
  cacheSoal=res.soal;
  cacheToken=res.token;
  renderAdmin();
  renderToken();
}

function renderAdmin(){
  let html = "";
  totalSoal.innerText = cacheSoal.length;

  cacheSoal.forEach((r,i)=>{
    html += `
    <tr>
      <td>${i+1}</td>
      <td>${r[1]}</td>
      <td>${r[2]}</td>
      <td>${r[3]} menit</td>
      <td>
        <div class="aksi-box">
          ${
            r[5]==1
            ? `
              <button class="btn btn-disabled" disabled>üîì Aktif</button>
              <button class="btn btn-disable"
                onclick="toggleSoal('${r[0]}',1)">üîí Nonaktifkan</button>
            `
            : `
              <button class="btn btn-enable"
                onclick="toggleSoal('${r[0]}',0)">üîì Aktifkan</button>
              <button class="btn btn-disabled" disabled>üîí Nonaktif</button>
            `
          }
          <button class="btn btn-delete"
            onclick="confirmHapus('${r[0]}')">üóëÔ∏è Hapus</button>
        </div>
      </td>
    </tr>`;
  });

  tableData.innerHTML = html; // ‚úÖ render hanya 1 kali
}


async function toggleSoal(id,status){

  const newStatus = status == 1 ? 0 : 1;

  // üîÑ Update UI dulu (biar terasa instan)
  const index = cacheSoal.findIndex(s => s[0] == id);
  if(index !== -1){
    cacheSoal[index][5] = newStatus;
    renderAdmin();
  }

  // üì° Kirim ke server di background
  await fetch(SCRIPT_URL,{
    method:"POST",
    body:JSON.stringify({
      action:"TOGGLE_SOAL",
      id:id,
      status:newStatus
    })
  });

}

function renderToken(){
  tokenTable.innerHTML="";
  cacheToken.forEach((r,i)=>{
    tokenTable.innerHTML+=`
      <tr>
        <td>${i+1}</td>
        <td>${r[1]}</td>
        <td><button onclick="hapusToken('${r[0]}')">Hapus</button></td>
      </tr>`;
  });
}

async function simpan(){
  await fetch(SCRIPT_URL,{
    method:"POST",
    body:JSON.stringify({
      action:"ADD_SOAL",
      jenis:jenis.value,
      mapel:mapel.value,
      durasi:durasi.value,
      link:link.value
    })
  });
  link.value = "";
  link.placeholder = "‚úîÔ∏è Link berhasil disimpan";
	setTimeout(()=>{
  link.placeholder = "Link Soal";
},1500);
  
  loadAdmin();
}



async function tambahToken(){
  if(!tokenBaru.value) return alert("Token kosong");
  await fetch(SCRIPT_URL,{
    method:"POST",
    body:JSON.stringify({action:"ADD_TOKEN",token:tokenBaru.value})
  });
  tokenBaru.value="";
  loadAdmin();
}

async function hapusToken(id){
  if(confirm("Hapus token?")){
    await fetch(SCRIPT_URL,{
      method:"POST",
      body:JSON.stringify({action:"DELETE_TOKEN",id})
    });
    loadAdmin();
  }
}

async function refreshSoalSiswa(){

  const token = sessionStorage.getItem("token");
  const nama  = sessionStorage.getItem("namaSiswa");

  if(!token){
    infoSoal.innerText = "‚ö†Ô∏è Token tidak ditemukan. Silakan login ulang.";
    return;
  }

  infoSoal.innerText = "‚è≥ Mengecek soal aktif...";

  try{

    const res = await fetch(SCRIPT_URL,{
      method:"POST",
      body:JSON.stringify({
        action:"LOGIN_SISWA",
        token: token
      })
    }).then(r=>r.json());

    if(res.status !== "LOGIN_OK"){
      infoSoal.innerText = "‚ùå Token tidak valid";
      return;
    }

    sessionStorage.setItem("soal", JSON.stringify(res.soal));
    cacheSoal = res.soal;

    if(cacheSoal.length === 0){
      infoSoal.innerText = "‚è≥ Soal belum dibuka oleh admin";
      cardData.innerHTML = "";
    }else{
      infoSoal.innerText = "‚úÖ Soal berhasil diperbarui";
      loadSiswa();
    }

  }catch(err){
    infoSoal.innerText = "‚ö†Ô∏è Gagal mengambil soal";
  }
}
function loadSiswa(){

  cacheSoal = JSON.parse(sessionStorage.getItem("soal") || "[]");
  const nama = sessionStorage.getItem("namaSiswa") || "";
  const no   = sessionStorage.getItem("noUjian") || "";
  namaTampil.innerHTML = `
  üë§ ${nama}<br>
  üìù No Ujian: ${no}
    `;
  const soalAktif = cacheSoal.filter(r => r && r[5] == 1);

  cardData.innerHTML = "";

  if(soalAktif.length === 0){
    cardData.innerHTML = `
      <div class="card">
        <h3>‚è≥ Belum ada soal aktif</h3>
        <p>Silakan tunggu instruksi dari guru.</p>
      </div>`;
    return;
  }

  const frag = document.createDocumentFragment();

  soalAktif.forEach(r=>{
    const div = document.createElement("div");
    div.className = "soal-card";

    div.innerHTML = `
      <span class="badge">${r[1]}</span>
      <h4>${r[2]}</h4>
      <p>Durasi ${r[3]} menit</p>
      <button onclick="mulaiUjian('${r[2]}',${r[3]},'${r[4]}')">
        üéì Mulai
      </button>
    `;

    frag.appendChild(div);
  });

  cardData.appendChild(frag);
}

function mulaiUjian(mapel,durasi,link){

  if(sessionStorage.getItem("preview")==="admin"){
    alert("Mode preview admin. Timer tetap berjalan, hasil tidak dikirim.");
  }

  siswaList.style.display="none";
  siswaUjian.style.display="block";
  judulUjian.innerText="Ujian "+mapel;
  frameSoal.src=link;

  sisaDetik=durasi*60;
  timerInterval=setInterval(()=>{
    sisaDetik--;
    timer.innerText=
      String(Math.floor(sisaDetik/60)).padStart(2,"0")+":"+
      String(sisaDetik%60).padStart(2,"0");
    if(sisaDetik<=0) keluarUjian();
  },1000);
  updateMonitor("Mengerjakan");
}
function updateMonitor(status){

  const nama = sessionStorage.getItem("namaSiswa");
  const no   = sessionStorage.getItem("noUjian");

  if(!nama || !no) return;

  fetch(MONITOR_URL,{
    method:"POST",
    body: JSON.stringify({
      nama:nama,
      no:no,
      status:status
    })
  });
}

function keluarUjian(){
    updateMonitor("Keluar");
  clearInterval(timerInterval);
  frameSoal.src="";
  siswaUjian.style.display="none";
  siswaList.style.display="block";
}
  
document.addEventListener("DOMContentLoaded",()=>{

  let hapusID = null;

  const confirmBox = document.getElementById("confirmBox");
  const confirmText = document.getElementById("confirmText");
  const confirmOk = document.getElementById("confirmOk");

  window.confirmHapus = function(id){
    hapusID = id;
    confirmText.innerText = "Yakin ingin menghapus soal ini?";
    confirmBox.style.display = "flex";
  }

  window.closeConfirm = function(){
    confirmBox.style.display = "none";
    hapusID = null;
  }

  confirmOk.onclick = async ()=>{
    if(!hapusID) return;

    await fetch(SCRIPT_URL,{
      method:"POST",
      body:JSON.stringify({
        action:"DELETE_SOAL",
        id: hapusID
      })
    });

    closeConfirm();
    loadAdmin();
  };

});

window.addEventListener("load",()=>{
   if(sessionStorage.getItem("login")==="true" &&
      sessionStorage.getItem("role")==="siswa"){

        loginBox.style.display="none";
        app.style.display="block";
        siswaMode.style.display="block";
        updateMonitor("Mengerjakan");
        setInterval(()=>{
            updateMonitor("Mengerjakan");
        },5000);

        loadSiswa();                   // tampil instan dari cache
        setTimeout(refreshSoalSiswa,500); // update data 0.5 detik kemudian
   }
});

window.addEventListener("beforeunload", ()=>{
  sessionStorage.clear();
});


async function loadMonitoring(){

  try{

    const res = await fetch(MONITOR_URL);
    const data = await res.json();

    const tbody = document.getElementById("monitoringTable");
    tbody.innerHTML = "";

    if(data.length === 0){
      tbody.innerHTML = `
        <tr>
          <td colspan="5">Belum ada siswa aktif</td>
        </tr>`;
      return;
    }

    data.slice(1).forEach((row,index)=>{

  const waktu = new Date(row[3]); // kolom lastActive
  const jam = isNaN(waktu) ? "-" : waktu.toLocaleString("id-ID");

  tbody.innerHTML += `
    <tr>
      <td>${index+1}</td>
      <td>${row[0] || "-"}</td>
      <td>${row[1] || "-"}</td>
      <td>${row[2] || "-"}</td>
      <td>${jam}</td>
    </tr>
  `;
});

  }catch(err){
    console.log("Monitoring error:", err);
  }
}
setInterval(()=>{
  if(sessionStorage.getItem("role")==="admin"){
    loadMonitoring();
  }
},5000);

let intervalMonitoring = setInterval(()=>{

  if(sessionStorage.getItem("role")==="siswa" && !sedangLogout){

    const no = sessionStorage.getItem("noUjian");
    const nama = sessionStorage.getItem("namaSiswa");

    const formData = new FormData();
    formData.append("noUjian", no);
    formData.append("nama", nama);
    formData.append("status", "Mengerjakan");

    fetch(MONITOR_URL,{
      method:"POST",
      body: formData
    });

  }

},5000);
	
async function hapusSelesai(){

  if(!confirm("Hapus SEMUA siswa yang sudah selesai ujian?")) return;

  const formData = new FormData();
  formData.append("action","DELETE_SELESAI");

  const res = await fetch(MONITOR_URL,{
    method:"POST",
    body: formData
  });

  const text = await res.text();
  console.log(text);

  loadMonitoring();
}



</script>

</body>
</html>
